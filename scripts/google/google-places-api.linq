<Query Kind="Program">
  <Connection>
    <ID>6f4524c1-972b-4cc8-98c0-c6d77e7a11c5</ID>
    <Persist>true</Persist>
    <Server>viso-sqlserver.database.windows.net,1433</Server>
    <SqlSecurity>true</SqlSecurity>
    <UserName>visosqladmin</UserName>
    <Password>AQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAzz+hiRIqzECPgd9EzojGEwAAAAACAAAAAAAQZgAAAAEAACAAAABS6hbo/p/0tuf52/NQw6VAnge7HGDQo+SSVJBpsbEo5AAAAAAOgAAAAAIAACAAAACeWWKRkapbqSbK0aZN47Gmpx8LtrhNCG7N9fKXszG5ShAAAABB+pqh+Hog9ivwvwZyTo4JQAAAAAB1v4Vh3eCK0/pcUkmh4QRhgoYlW+ot4eBrw3NfbOsfI5WFkUqs2vqkVY2bVtcwH6VOLaarnZomgmHMmQwPCtM=</Password>
    <DbVersion>Azure</DbVersion>
    <IsProduction>true</IsProduction>
    <DisplayName>viso-prod</DisplayName>
    <Database>Viso</Database>
    <ShowServer>true</ShowServer>
  </Connection>
  <Reference>&lt;RuntimeDirectory&gt;\System.Threading.Tasks.dll</Reference>
  <Reference Relative="..\..\source\Vita.Api\bin\Debug\netcoreapp2.1\Vita.Api.dll">C:\dev\vita\source\Vita.Api\bin\Debug\netcoreapp2.1\Vita.Api.dll</Reference>
  <Reference Relative="..\..\source\Vita.Api\bin\Debug\netcoreapp2.1\Vita.Contracts.dll">C:\dev\vita\source\Vita.Api\bin\Debug\netcoreapp2.1\Vita.Contracts.dll</Reference>
  <Reference Relative="..\..\source\Vita.Api\bin\Debug\netcoreapp2.1\Vita.Domain.dll">C:\dev\vita\source\Vita.Api\bin\Debug\netcoreapp2.1\Vita.Domain.dll</Reference>
  <Reference Relative="..\..\source\Vita.Api\bin\Debug\netcoreapp2.1\Vita.Predictor.dll">C:\dev\vita\source\Vita.Api\bin\Debug\netcoreapp2.1\Vita.Predictor.dll</Reference>
  <NuGetReference>CsvHelper</NuGetReference>
  <NuGetReference>GoogleApi</NuGetReference>
  <NuGetReference>LiteDB</NuGetReference>
  <NuGetReference>Microsoft.Azure.Search.Service</NuGetReference>
  <NuGetReference>Serilog</NuGetReference>
  <Namespace>CsvHelper</Namespace>
  <Namespace>CsvHelper.Configuration</Namespace>
  <Namespace>CsvHelper.Configuration.Attributes</Namespace>
  <Namespace>CsvHelper.Expressions</Namespace>
  <Namespace>CsvHelper.TypeConversion</Namespace>
  <Namespace>GoogleApi</Namespace>
  <Namespace>GoogleApi.Entities</Namespace>
  <Namespace>GoogleApi.Entities.Common</Namespace>
  <Namespace>GoogleApi.Entities.Common.Converters</Namespace>
  <Namespace>GoogleApi.Entities.Common.Enums</Namespace>
  <Namespace>GoogleApi.Entities.Common.Enums.Extensions</Namespace>
  <Namespace>GoogleApi.Entities.Common.Extensions</Namespace>
  <Namespace>GoogleApi.Entities.Interfaces</Namespace>
  <Namespace>GoogleApi.Entities.Maps</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Common</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Common.Enums</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Directions.Request</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Directions.Response</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Directions.Response.Enums</Namespace>
  <Namespace>GoogleApi.Entities.Maps.DistanceMatrix.Request</Namespace>
  <Namespace>GoogleApi.Entities.Maps.DistanceMatrix.Response</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Elevation.Request</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Elevation.Response</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Geocoding</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Geocoding.Address.Request</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Geocoding.Common</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Geocoding.Common.Enums</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Geocoding.Location.Request</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Geocoding.Place.Request</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Geocoding.PlusCode.Request</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Geocoding.PlusCode.Response</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Geolocation.Request</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Geolocation.Request.Enums</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Geolocation.Response</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Roads</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Roads.Common</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Roads.Common.Enums</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Roads.NearestRoads.Request</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Roads.NearestRoads.Response</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Roads.SnapToRoads.Request</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Roads.SnapToRoads.Response</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Roads.SpeedLimits.Request</Namespace>
  <Namespace>GoogleApi.Entities.Maps.Roads.SpeedLimits.Response</Namespace>
  <Namespace>GoogleApi.Entities.Maps.StaticMaps.Request</Namespace>
  <Namespace>GoogleApi.Entities.Maps.StaticMaps.Request.Enums</Namespace>
  <Namespace>GoogleApi.Entities.Maps.StaticMaps.Request.Enums.Extensions</Namespace>
  <Namespace>GoogleApi.Entities.Maps.StaticMaps.Response</Namespace>
  <Namespace>GoogleApi.Entities.Maps.StreetView.Request</Namespace>
  <Namespace>GoogleApi.Entities.Maps.StreetView.Response</Namespace>
  <Namespace>GoogleApi.Entities.Maps.TimeZone.Request</Namespace>
  <Namespace>GoogleApi.Entities.Maps.TimeZone.Response</Namespace>
  <Namespace>GoogleApi.Entities.Places</Namespace>
  <Namespace>GoogleApi.Entities.Places.AutoComplete.Request</Namespace>
  <Namespace>GoogleApi.Entities.Places.AutoComplete.Request.Enums</Namespace>
  <Namespace>GoogleApi.Entities.Places.AutoComplete.Response</Namespace>
  <Namespace>GoogleApi.Entities.Places.Common</Namespace>
  <Namespace>GoogleApi.Entities.Places.Common.Enums</Namespace>
  <Namespace>GoogleApi.Entities.Places.Details.Request</Namespace>
  <Namespace>GoogleApi.Entities.Places.Details.Request.Enums</Namespace>
  <Namespace>GoogleApi.Entities.Places.Details.Response</Namespace>
  <Namespace>GoogleApi.Entities.Places.Photos.Request</Namespace>
  <Namespace>GoogleApi.Entities.Places.Photos.Response</Namespace>
  <Namespace>GoogleApi.Entities.Places.QueryAutoComplete.Request</Namespace>
  <Namespace>GoogleApi.Entities.Places.QueryAutoComplete.Response</Namespace>
  <Namespace>GoogleApi.Entities.Places.Search.Common</Namespace>
  <Namespace>GoogleApi.Entities.Places.Search.Common.Enums</Namespace>
  <Namespace>GoogleApi.Entities.Places.Search.Find.Request</Namespace>
  <Namespace>GoogleApi.Entities.Places.Search.Find.Request.Enums</Namespace>
  <Namespace>GoogleApi.Entities.Places.Search.Find.Response</Namespace>
  <Namespace>GoogleApi.Entities.Places.Search.NearBy.Request</Namespace>
  <Namespace>GoogleApi.Entities.Places.Search.NearBy.Request.Enums</Namespace>
  <Namespace>GoogleApi.Entities.Places.Search.NearBy.Response</Namespace>
  <Namespace>GoogleApi.Entities.Places.Search.Text.Request</Namespace>
  <Namespace>GoogleApi.Entities.Places.Search.Text.Response</Namespace>
  <Namespace>GoogleApi.Entities.Search</Namespace>
  <Namespace>LiteDB</Namespace>
  <Namespace>LiteDB.Shell</Namespace>
  <Namespace>Serilog</Namespace>
  <Namespace>Vita.Contracts</Namespace>
  <Namespace>Vita.Contracts.ChargeId</Namespace>
</Query>

const string PlacePath = @"D:\Dropbox\Dropbox (Personal)\Red-Trout\chargeid\data\Place.db";
const string ChargePath = @"D:\Dropbox\Dropbox (Personal)\Red-Trout\chargeid\data\Charge.db";

List<Place> places = new List<Place>();
List<Charge> charges = new List<Charge>();
List<string> seen = new List<string>();
Vita.Domain.Services.GooglePlacesSearcher search = new Vita.Domain.Services.GooglePlacesSearcher();

async System.Threading.Tasks.Task Main()
{
	//	var data = ShowDatabase();
	//	data.Dump();


	Random random = new Random();
	int seed = random.Next(1, 50000);

	//RunFromTsv();

	var bad = new List<string>{"credit","overdrawn", "debit", "fee", "eftpos", "withdrawal", "atm", "salary", "pension", "interest", "transfer", "deposit"};
	
	var data = BsAccountTransactions
	.Skip(seed)
	.Take(3000);

	foreach (var item in data) {
		bool ignore = false;
		foreach (var word in bad)
		{
			//Console.WriteLine(item.Text.ToLowerInvariant());
			if (Regex.IsMatch(item.Text.ToLowerInvariant(), $@"\b{word}\b"))
			{
				ignore = true;
				break;
			}
		}

		if (ignore)
		{
			//Console.WriteLine($"ignore {item.Text}");
			ignore = false;
			continue;
		};


		string searchPhrase = item.Text.ToLowerInvariant();

		if (seen.Contains(searchPhrase))
		{
			Console.WriteLine($"seen {searchPhrase}");
			continue;
		}

		Console.WriteLine($"FIND {searchPhrase}");
		var charge = FindCharge(searchPhrase);
		//charge.BankName = item..Bank;
		//charge.Amount = x.Amount;
		//charge.AccountNumber = x.AccountNumber;
		charge.SearchPhrase = searchPhrase;
		//charge.TransactionUtcDate = x.TransactionUtcDate;
		//charge.Notes = x.Notes;
		//charge.Tags = x.Tags;
		charges.Add(charge);

		seen.Add(searchPhrase);
	}

	try {
		
		await RunSearch();
	}
	catch(Exception ex) {
		ex.Dump("ERROR");
	}
	

	using (var db = new LiteDatabase(PlacePath))
	{
		var repo = db.GetCollection<Vita.Contracts.Place>();
		repo.EnsureIndex(x => x.PlaceId, true);
		foreach (var c in places)
		{
			if (repo.Exists(x => x.PlaceId == c.PlaceId))
			{
				repo.Update(c);
			}
			else
			{
				repo.Insert(c);
			}
		}
	}

	using (var db = new LiteDatabase(ChargePath))
	{
		var repo = db.GetCollection<Vita.Contracts.Charge>();

		foreach (var c in charges)
		{
			if (repo.Exists(x=>x.SearchPhrase == c.SearchPhrase)){
				repo.Update(c);
			}
			else {
				repo.Insert(c);
			}
		}
	}

	charges.Dump("charges");
	places.Dump("places");
	
}

private async System.Threading.Tasks.Task RunSearch() {

	for (var i = 0; i < charges.ToArray().Length; i++)
	{
		var result = await search.SearchAsync(charges[i].SearchPhrase);
		seen.Add(charges[i].SearchPhrase);
		if (result.Status == Status.Ok)
		{
			foreach (var r in result.Results)
			{
				charges[i].PlaceId = r.PlaceId;
				if (charges[i].PlaceLocationTypes == null)
				{
					charges[i].PlaceLocationTypes = new List<PlaceLocationType>();
				}

				r.Types.ToList().ForEach(x => charges[i].PlaceLocationTypes.Add(x.Value));

				var p = new Place
				{
					Id = Guid.NewGuid(),
					CreatedUtc = DateTime.UtcNow,
					Name = r.Name,
					PlaceId = r.PlaceId,
					Types = r.Types,
					FormattedAddress = r.FormattedAddress
				};

				places.Add(p);
			}
		}
		else
		{
			Console.WriteLine($"{charges[i].SearchPhrase} {result.Status}");
		}
	}

}


private void RunFromTsv()
{
	string contents = File.ReadAllText(@"C:\dev\vita\data\test.tsv");
	var tsv = Vita.Domain.Infrastructure.FileUtil.Read(contents);
	foreach (var x in tsv)
	{
		string searchPhrase = x.Description.ToLowerInvariant();

		if (seen.Contains(searchPhrase))
		{
			Console.WriteLine($"seen {searchPhrase}");
			continue;
		}

		var charge = FindCharge(searchPhrase);
		charge.BankName = x.Bank;
		charge.Amount = x.Amount;
		charge.SearchPhrase = searchPhrase;		
		charge.Notes = x.Notes;
		charge.Tags = x.Tags;
		charges.Add(charge);
		
	//	seen.Add(searchPhrase);
	}
}

private Vita.Contracts.Charge FindCharge(string name)
{
	if (string.IsNullOrEmpty(name)) throw new ArgumentNullException();
	using (var db = new LiteDatabase(ChargePath))
	{
		var repo = db.GetCollection<Vita.Contracts.Charge>();
		var found = (repo.Find(x=>x.SearchPhrase.ToLowerInvariant() == name.ToLowerInvariant()));
		if (found!=null && found.Any()) return found.First();	
	}

	var chg = new Charge() {
		Id = Guid.NewGuid(),
		CreatedUtc = DateTime.UtcNow
	};
	
	return chg;
}


private IEnumerable<Vita.Contracts.Place> ShowDatabase()
{
	using (var db = new LiteDatabase(PlacePath))
	{
		var repo = db.GetCollection<Vita.Contracts.Place>();
		var data = repo.FindAll()
		;

		return data;
	}
}